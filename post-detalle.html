<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Detalle del Caso - Seguridad Comunitaria</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --accent: #ef4444;
            --bg-dark: #0d0e14;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-main: #cbd5e1;
        }

        body {
            background: radial-gradient(circle at top, #1a1c2c 0%, var(--bg-dark) 100%);
            min-height: 100vh;
            color: white;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 850px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* DISE√ëO DE LA TARJETA DE LECTURA */
        .content-card {
            background: var(--card-bg);
            padding: 40px; /* M√°s espacio interno */
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            
            /* ESTOS SON LOS CAMBIOS PARA QUE NO SE VEA AMONTONADO */
            line-height: 1.8;      /* Espacio entre l√≠neas */
            font-size: 1.1rem;     /* Tama√±o de letra c√≥modo */
            color: var(--text-main);
            white-space: pre-wrap; /* Respeta los saltos de l√≠nea del administrador */
        }

        /* Espacio extra entre p√°rrafos */
        .content-card div, .content-card p {
            margin-bottom: 20px;
        }

        .post-header {
            margin-bottom: 40px;
            text-align: center;
        }

        .post-header h1 {
            font-size: clamp(1.8rem, 5vw, 2.8rem);
            margin-top: 10px;
            line-height: 1.2;
        }

        .post-date {
            color: var(--primary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .interactions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .btn-vote {
            padding: 12px 25px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: white;
            cursor: pointer;
            transition: 0.3s;
            font-family: inherit;
        }

        .back-nav {
            margin-bottom: 20px;
        }

        .back-nav a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <div class="container">
        <nav class="back-nav">
            <a href="grooming.html">‚Üê Volver a Historias</a>
        </nav>

        <div id="detalle-post">
            </div>
    </div>

    
    <script type="module">
        import { db, doc, getDoc, updateDoc, increment, collection, addDoc, query, where, getDocs, Timestamp } from './firebase.js';

        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        const container = document.getElementById('detalle-post');

        // ===== FUNCI√ìN PARA GENERAR FINGERPRINT =====
        async function generarFingerprint() {
            const data = [
                navigator.userAgent,
                navigator.language,
                screen.width,
                screen.height,
                new Date().getTimezoneOffset()
            ].join('|');
            
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                const char = data.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // ===== VERIFICAR SI YA VOT√ì =====
        async function yaVoto(postId, fingerprint) {
            const q = query(
                collection(db, "votos"),
                where("postId", "==", postId),
                where("userFingerprint", "==", fingerprint)
            );
            const snap = await getDocs(q);
            return !snap.empty ? snap.docs[0].data().tipo : null;
        }

        // ===== REGISTRAR VOTO =====
        async function gestionarVoto(tipo) {
            const fingerprint = await generarFingerprint();
            const votoExistente = await yaVoto(postId, fingerprint);
            
            if (votoExistente) {
                alert(`Ya votaste con ${votoExistente === 'likes' ? 'üëç Like' : 'üëé Dislike'}`);
                return;
            }
            
            try {
                await addDoc(collection(db, "votos"), {
                    postId,
                    userFingerprint: fingerprint,
                    tipo,
                    fecha: Timestamp.now()
                });
                
                const docRef = doc(db, "posts", postId);
                await updateDoc(docRef, { [tipo]: increment(1) });
                
                location.reload();
            } catch (e) {
                console.error(e);
                alert("Error al votar. Intenta nuevamente.");
            }
        }

        // ===== FUNCI√ìN PARA SANITIZAR HTML =====
        function sanitizarHTML(texto) {
            const div = document.createElement('div');
            div.textContent = texto;
            let safe = div.innerHTML;
            safe = safe.replace(/\n/g, '<br>');
            return safe;
        }

        // ===== CARGAR POST =====
        async function cargarTodo() {
            if (!postId) {
                container.innerHTML = '<p style="color: #ef4444;">‚ö†Ô∏è No se especific√≥ ning√∫n post</p>';
                return;
            }
            
            try {
                const docRef = doc(db, "posts", postId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const fingerprint = await generarFingerprint();
                    const votoExistente = await yaVoto(postId, fingerprint);
                    
                    const fecha = data.fecha?.toDate().toLocaleDateString('es-ES', {
                        day: '2-digit', month: 'long', year: 'numeric'
                    }) || "Reciente";

                    container.innerHTML = `
                        <header class="post-header">
                            <span class="post-date">Publicado el ${fecha}</span>
                            <h1>${sanitizarHTML(data.titulo)}</h1>
                        </header>
                        <div class="post-body">
                            <div class="content-card">${sanitizarHTML(data.contenido)}</div>
                            
                            <div class="interactions">
                                <button id="btn-like" class="btn-vote">
                                    üëç <span class="count">${data.likes || 0}</span> Like
                                </button>
                                <button id="btn-dislike" class="btn-vote">
                                    üëé <span class="count">${data.dislikes || 0}</span> Dislike
                                </button>
                            </div>
                        </div>
                    `;

                    const btnL = document.getElementById('btn-like');
                    const btnD = document.getElementById('btn-dislike');

                    if (votoExistente) {
                        btnL.style.cursor = "not-allowed";
                        btnD.style.cursor = "not-allowed";
                        btnL.style.opacity = "0.6";
                        btnD.style.opacity = "0.6";
                        
                        if (votoExistente === 'likes') {
                            btnL.style.background = "#4ade80";
                            btnL.style.color = "black";
                            btnL.style.opacity = "1";
                        }
                        if (votoExistente === 'dislikes') {
                            btnD.style.background = "#ef4444";
                            btnD.style.color = "white";
                            btnD.style.opacity = "1";
                        }
                    } else {
                        btnL.onclick = () => gestionarVoto('likes');
                        btnD.onclick = () => gestionarVoto('dislikes');
                    }
                } else {
                    container.innerHTML = '<p style="color: #ef4444;">‚ö†Ô∏è Este post no existe</p>';
                }
            } catch (error) { 
                console.error(error);
                container.innerHTML = '<p style="color: #ef4444;">‚ùå Error al cargar el post</p>';
            }
        }

        cargarTodo();
    </script>
</body>
</html>